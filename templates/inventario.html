{% extends 'base.html' %}
{% set title = 'Buscador Global' %}
{% block content %}
<div class="mb-4">
  <h4 class="mb-3"><i class="bi bi-search me-2"></i>Buscador Global de Equipos e Items</h4>
  <p class="text-muted">Busca cualquier equipo o item en todos los laboratorios y talleres del centro</p>
</div>

<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-5">
            <div class="input-group input-group-lg">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input id="filtroBusqueda" type="text" class="form-control" placeholder="Buscar por nombre, tipo, categor√≠a o ubicaci√≥n..." autofocus>
            </div>
          </div>
          <div class="col-md-3">
            <select id="filtroTipo" class="form-select form-select-lg">
              <option value="">üîç Todos (Equipos e Items)</option>
              <option value="equipo">üîß Solo Equipos</option>
              <option value="item">üì¶ Solo Items</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="filtroLaboratorio" class="form-select form-select-lg">
              <option value="">Todos los labs</option>
              {% for lab in laboratorios %}
              <option value="{{ lab.id }}">{{ lab.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-sena btn-lg w-100" id="btnExportCSV">
              <i class="bi bi-filetype-csv me-1"></i>Exportar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span class="badge bg-primary" id="totalResultados">{{ (equipos|length) + (inventario|length) }} resultados</span>
        <span class="badge bg-info" id="totalEquipos">{{ equipos|length }} equipos</span>
        <span class="badge bg-success" id="totalItems">{{ inventario|length }} items</span>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive shadow-sm bg-white rounded">
  <table class="table table-hover align-middle mb-0" id="tablaResultados">
    <thead class="table-light">
      <tr>
        <th>Tipo</th>
        <th>Nombre</th>
        <th>Categor√≠a/Tipo</th>
        <th><i class="bi bi-building me-1"></i>Laboratorio</th>
        <th>Ubicaci√≥n</th>
        <th>Estado/Cantidad</th>
        <th>Informaci√≥n Adicional</th>
      </tr>
    </thead>
    <tbody>
      <!-- EQUIPOS -->
      {% for e in equipos %}
      <tr data-tipo="equipo"
          data-nombre="{{ e.nombre|lower }}" 
          data-cat="{{ e.tipo|lower }}" 
          data-estado="{{ e.estado }}"
          data-lab="{{ e.laboratorio_id }}"
          data-ubicacion="{{ (e.ubicacion or '')|lower }}">
        <td>
          <span class="badge bg-info">
            <i class="bi bi-cpu"></i> EQUIPO
          </span>
        </td>
        <td>
          <div class="fw-semibold">{{ e.nombre }}</div>
          <small class="text-muted">ID: {{ e.id }}</small>
        </td>
        <td>
          <span class="badge bg-light text-dark">{{ e.tipo }}</span>
        </td>
        <td>
          <span class="badge bg-primary">
            <i class="bi bi-building"></i> {{ e.laboratorio_nombre }}
          </span>
        </td>
        <td>
          <i class="bi bi-geo-alt text-muted"></i>
          {{ e.ubicacion or 'No especificada' }}
        </td>
        <td>
          {% set badge = 'success' if e.estado=='disponible' else ('info' if e.estado=='en_uso' else ('warning' if e.estado=='mantenimiento' else 'danger')) %}
          <span class="badge bg-{{ badge }} text-uppercase">
            {{ e.estado }}
          </span>
        </td>
        <td>
          <small class="text-muted">
            {% if e.calibracion %}
              üìÖ Calibraci√≥n: {{ e.calibracion }}
            {% endif %}
          </small>
        </td>
      </tr>
      {% endfor %}
      
      <!-- ITEMS DE INVENTARIO -->
      {% for i in inventario %}
      <tr data-tipo="item"
          data-nombre="{{ i.nombre|lower }}" 
          data-cat="{{ i.categoria|lower }}" 
          data-estado="{{ i.nivel_stock }}"
          data-lab="{{ i.laboratorio_id }}"
          data-ubicacion="{{ (i.ubicacion or '')|lower }}">
        <td>
          <span class="badge bg-success">
            <i class="bi bi-box-seam"></i> ITEM
          </span>
        </td>
        <td>
          <div class="fw-semibold">{{ i.nombre }}</div>
          <small class="text-muted">ID: {{ i.id }}</small>
        </td>
        <td>
          <span class="badge bg-light text-dark">{{ i.categoria }}</span>
        </td>
        <td>
          <span class="badge bg-primary">
            <i class="bi bi-building"></i> {{ i.laboratorio_nombre }}
          </span>
        </td>
        <td>
          <i class="bi bi-geo-alt text-muted"></i>
          {{ i.ubicacion or 'No especificada' }}
        </td>
        <td>
          <strong class="fs-5">{{ i.cantidad_actual }}</strong> / {{ i.cantidad_minima }}
          {% set badge = 'danger' if i.nivel_stock=='critico' else ('warning' if i.nivel_stock=='bajo' else 'success') %}
          <span class="badge bg-{{ badge }} ms-2">{{ i.nivel_stock }}</span>
        </td>
        <td>
          <small class="text-muted">
            {{ i.unidad }}
            {% if i.proveedor %} ‚Ä¢ {{ i.proveedor }}{% endif %}
            {% if i.vencimiento %} ‚Ä¢ Vence: {{ i.vencimiento }}{% endif %}
          </small>
        </td>
      </tr>
      {% endfor %}
      
      {% if not equipos and not inventario %}
      <tr>
        <td colspan="7" class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          No se encontraron resultados
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
  const busquedaFilter = document.getElementById('filtroBusqueda');
  const tipoFilter = document.getElementById('filtroTipo');
  const labFilter = document.getElementById('filtroLaboratorio');
  const tbody = document.querySelector('#tablaResultados tbody');
  const totalBadge = document.getElementById('totalResultados');
  const equiposBadge = document.getElementById('totalEquipos');
  const itemsBadge = document.getElementById('totalItems');
  
  function filtrar(){
    const t = (busquedaFilter.value || '').toLowerCase();
    const tipo = tipoFilter.value;
    const lab = labFilter.value;
    
    let visibleCount = 0;
    let visibleEquipos = 0;
    let visibleItems = 0;
    
    [...tbody.rows].forEach(r=>{
      // Buscar en nombre, categor√≠a y ubicaci√≥n
      const okTxt = r.dataset.nombre.includes(t) || 
                    r.dataset.cat.includes(t) || 
                    r.dataset.ubicacion.includes(t);
      const okTipo = !tipo || r.dataset.tipo === tipo;
      const okLab = !lab || r.dataset.lab === lab;
      
      const visible = okTxt && okTipo && okLab;
      r.classList.toggle('d-none', !visible);
      
      if (visible) {
        visibleCount++;
        if (r.dataset.tipo === 'equipo') visibleEquipos++;
        else visibleItems++;
      }
    });
    
    // Actualizar contadores
    totalBadge.textContent = `${visibleCount} resultados`;
    equiposBadge.textContent = `${visibleEquipos} equipos`;
    itemsBadge.textContent = `${visibleItems} items`;
  }
  
  busquedaFilter.addEventListener('input', filtrar);
  tipoFilter.addEventListener('change', filtrar);
  labFilter.addEventListener('change', filtrar);

  // Exportar CSV
  document.getElementById('btnExportCSV').addEventListener('click', ()=>{
    const rows = [['Tipo','Nombre','ID','Categoria/Tipo','Laboratorio','Ubicacion','Estado/Cantidad','Info Adicional']];
    [...tbody.rows].forEach(r=>{
      if(r.classList.contains('d-none')) return;
      const c=(sel)=>r.querySelector(sel)?.innerText.trim().replace(/\n/g, ' ')||'';
      rows.push([
        c('td:nth-child(1)'),
        c('td:nth-child(2)').split('\n')[0],
        r.querySelector('td:nth-child(2) small')?.innerText.replace('ID: ','') || '',
        c('td:nth-child(3)'),
        c('td:nth-child(4)'),
        c('td:nth-child(5)'),
        c('td:nth-child(6)'),
        c('td:nth-child(7)')
      ]);
    });
    const csv = rows.map(a=>a.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href=url; 
    a.download=`busqueda_global_${new Date().toISOString().split('T')[0]}.csv`; 
    a.click(); 
    URL.revokeObjectURL(url);
  });
</script>
{% endblock %}
