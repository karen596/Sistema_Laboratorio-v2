{% extends 'base.html' %}
{% set title = 'Buscador Global' %}
{% block content %}
<style>
  /* Tabla más compacta y organizada */
  #tablaResultados td {
    white-space: nowrap;
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
  }
  
  #tablaResultados td small {
    display: inline;
    white-space: nowrap;
  }
  
  #tablaResultados .badge {
    white-space: nowrap;
  }
  
  /* Ajustar ancho de columnas */
  #tablaResultados th:nth-child(1) { width: 8%; }  /* Tipo */
  #tablaResultados th:nth-child(2) { width: 18%; } /* Nombre */
  #tablaResultados th:nth-child(3) { width: 12%; } /* Categoría */
  #tablaResultados th:nth-child(4) { width: 15%; } /* Laboratorio */
  #tablaResultados th:nth-child(5) { width: 15%; } /* Ubicación */
  #tablaResultados th:nth-child(6) { width: 12%; } /* Estado */
  #tablaResultados th:nth-child(7) { width: 20%; } /* Info Adicional */
  
  /* Evitar saltos de línea en badges */
  #tablaResultados .badge {
    display: inline-block;
    font-size: 0.75rem;
  }
  
  /* Estilos para impresión PDF */
  @media print {
    .navbar, .sidebar, .footer, .btn, .form-control, .form-select, .card, .mb-4, .mb-3 {
      display: none !important;
    }
    
    #tablaResultados {
      width: 100%;
      border-collapse: collapse;
    }
    
    #tablaResultados th, #tablaResultados td {
      border: 1px solid #000;
      padding: 8px;
      font-size: 10pt;
    }
    
    #tablaResultados thead {
      background: #2D6A4F !important;
      color: white !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    .table-responsive {
      display: block !important;
      overflow: visible !important;
    }
    
    @page {
      size: landscape;
      margin: 1cm;
    }
  }
</style>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}"><i class="bi bi-house-door"></i> Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Buscador Global</li>
  </ol>
</nav>

<!-- Header -->
<div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
  <div class="card-body p-4">
    <h4 class="mb-1 text-white fw-bold"><i class="bi bi-search me-2"></i>Buscador Global de Equipos e Items</h4>
    <p class="mb-0 text-white opacity-90">Busca cualquier equipo o item en todos los laboratorios y talleres del centro</p>
  </div>
</div>

<!-- Filtros de Búsqueda -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header border-0" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        <h6 class="mb-0 fw-bold" style="color: #2d6a4f;"><i class="bi bi-funnel me-2"></i>Filtros de Búsqueda</h6>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-5">
            <label class="form-label fw-semibold" style="color: #2d6a4f;">Búsqueda</label>
            <div class="input-group">
              <span class="input-group-text" style="background: #f8f9fa; border-color: #dee2e6;"><i class="bi bi-search"></i></span>
              <input id="filtroBusqueda" type="text" class="form-control" placeholder="Buscar por nombre, tipo, categoría..." autofocus>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold" style="color: #2d6a4f;">Tipo</label>
            <select id="filtroTipo" class="form-select">
              <option value="">Todos (Equipos e Items)</option>
              <option value="equipo">Solo Equipos</option>
              <option value="item">Solo Items</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold" style="color: #2d6a4f;">Laboratorio</label>
            <select id="filtroLaboratorio" class="form-select">
              <option value="">Todos</option>
              {% for lab in laboratorios %}
              <option value="{{ lab.id }}">{{ lab.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold" style="color: #2d6a4f;">Exportar</label>
            <select class="form-select" id="selectExport">
              <option value="">Seleccionar...</option>
              <option value="excel">Excel (.xls)</option>
              <option value="pdf">PDF</option>
              <option value="csv">CSV</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estadísticas -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #00b894 0%, #009b7d 100%);">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <div class="rounded-3 p-2" style="background: rgba(255,255,255,0.2);">
              <i class="bi bi-search fs-3 text-white"></i>
            </div>
          </div>
          <div class="text-white">
            <div class="small opacity-90">Total Resultados</div>
            <div class="fs-3 fw-bold" id="totalResultados">{{ (equipos|length) + (inventario|length) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <div class="rounded-3 p-2" style="background: rgba(255,255,255,0.2);">
              <i class="bi bi-cpu fs-3 text-white"></i>
            </div>
          </div>
          <div class="text-white">
            <div class="small opacity-90">Equipos</div>
            <div class="fs-3 fw-bold" id="totalEquipos">{{ equipos|length }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
      <div class="card-body p-3">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <div class="rounded-3 p-2" style="background: rgba(255,255,255,0.2);">
              <i class="bi bi-box-seam fs-3 text-white"></i>
            </div>
          </div>
          <div class="text-white">
            <div class="small opacity-90">Items</div>
            <div class="fs-3 fw-bold" id="totalItems">{{ inventario|length }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tabla de Resultados -->
<div class="card border-0 shadow-sm">
  <div class="card-header border-0" style="background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);">
    <h6 class="mb-0 text-white fw-bold"><i class="bi bi-table me-2"></i>Resultados de Búsqueda</h6>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="tablaResultados">
        <thead style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
          <tr style="color: #2d6a4f; font-weight: 600;">
            <th>Tipo</th>
            <th>Nombre</th>
            <th>Categoría/Tipo</th>
            <th><i class="bi bi-building me-1"></i>Laboratorio</th>
            <th>Ubicación</th>
            <th>Estado/Cantidad</th>
            <th>Información Adicional</th>
          </tr>
        </thead>
    <tbody>
      <!-- EQUIPOS -->
      {% for e in equipos %}
      <tr data-tipo="equipo"
          data-nombre="{{ e.nombre|lower }}" 
          data-cat="{{ e.tipo|lower }}" 
          data-estado="{{ e.estado }}"
          data-lab="{{ e.laboratorio_id }}"
          data-ubicacion="{{ (e.ubicacion or '')|lower }}">
        <td>
          <span class="badge bg-info">
            <i class="bi bi-cpu"></i> EQUIPO
          </span>
        </td>
        <td>
          <div class="fw-semibold">{{ e.nombre }}</div>
          <small class="text-muted">ID: {{ e.id }}</small>
        </td>
        <td>
          <span class="badge bg-light text-dark">{{ e.tipo }}</span>
        </td>
        <td>
          <span class="badge" style="background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); color: white;">
            <i class="bi bi-building"></i> {{ e.laboratorio_nombre }}
          </span>
        </td>
        <td>
          <i class="bi bi-geo-alt text-muted"></i>
          {{ e.ubicacion or 'No especificada' }}
        </td>
        <td>
          {% set badge = 'success' if e.estado=='disponible' else ('info' if e.estado=='en_uso' else ('warning' if e.estado=='mantenimiento' else 'danger')) %}
          <span class="badge bg-{{ badge }} text-uppercase">
            {{ e.estado }}
          </span>
        </td>
        <td>
          <small class="text-muted">
            {% if e.calibracion %}
              📅 Calibración: {{ e.calibracion }}
            {% endif %}
          </small>
        </td>
      </tr>
      {% endfor %}
      
      <!-- ITEMS DE INVENTARIO -->
      {% for i in inventario %}
      <tr data-tipo="item"
          data-nombre="{{ i.nombre|lower }}" 
          data-cat="{{ i.categoria|lower }}" 
          data-estado="{{ i.nivel_stock }}"
          data-lab="{{ i.laboratorio_id }}"
          data-ubicacion="{{ (i.ubicacion or '')|lower }}">
        <td>
          <span class="badge bg-success">
            <i class="bi bi-box-seam"></i> ITEM
          </span>
        </td>
        <td>
          <div class="fw-semibold">{{ i.nombre }}</div>
          <small class="text-muted">ID: {{ i.id }}</small>
        </td>
        <td>
          <span class="badge bg-light text-dark">{{ i.categoria }}</span>
        </td>
        <td>
          <span class="badge" style="background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); color: white;">
            <i class="bi bi-building"></i> {{ i.laboratorio_nombre }}
          </span>
        </td>
        <td>
          <i class="bi bi-geo-alt text-muted"></i>
          {{ i.ubicacion or 'No especificada' }}
        </td>
        <td>
          <strong class="fs-5">{{ i.cantidad_actual }}</strong> / {{ i.cantidad_minima }}
          {% set badge = 'danger' if i.nivel_stock=='critico' else ('warning' if i.nivel_stock=='bajo' else 'success') %}
          <span class="badge bg-{{ badge }} ms-2">{{ i.nivel_stock }}</span>
        </td>
        <td>
          <small class="text-muted">
            {{ i.unidad }}
            {% if i.proveedor %} • {{ i.proveedor }}{% endif %}
            {% if i.vencimiento %} • Vence: {{ i.vencimiento }}{% endif %}
          </small>
        </td>
      </tr>
      {% endfor %}
      
      {% if not equipos and not inventario %}
      <tr>
        <td colspan="7" class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          No se encontraron resultados
        </td>
      </tr>
      {% endif %}
    </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const busquedaFilter = document.getElementById('filtroBusqueda');
  const tipoFilter = document.getElementById('filtroTipo');
  const labFilter = document.getElementById('filtroLaboratorio');
  const tbody = document.querySelector('#tablaResultados tbody');
  const totalBadge = document.getElementById('totalResultados');
  const equiposBadge = document.getElementById('totalEquipos');
  const itemsBadge = document.getElementById('totalItems');
  
  function filtrar(){
    const t = (busquedaFilter.value || '').toLowerCase();
    const tipo = tipoFilter.value;
    const lab = labFilter.value;
    
    let visibleCount = 0;
    let visibleEquipos = 0;
    let visibleItems = 0;
    
    [...tbody.rows].forEach(r=>{
      // Buscar en nombre, categoría y ubicación
      const okTxt = r.dataset.nombre.includes(t) || 
                    r.dataset.cat.includes(t) || 
                    r.dataset.ubicacion.includes(t);
      const okTipo = !tipo || r.dataset.tipo === tipo;
      const okLab = !lab || r.dataset.lab === lab;
      
      const visible = okTxt && okTipo && okLab;
      r.classList.toggle('d-none', !visible);
      
      if (visible) {
        visibleCount++;
        if (r.dataset.tipo === 'equipo') visibleEquipos++;
        else visibleItems++;
      }
    });
    
    // Actualizar contadores
    totalBadge.textContent = `${visibleCount} resultados`;
    equiposBadge.textContent = `${visibleEquipos} equipos`;
    itemsBadge.textContent = `${visibleItems} items`;
  }
  
  busquedaFilter.addEventListener('input', filtrar);
  tipoFilter.addEventListener('change', filtrar);
  labFilter.addEventListener('change', filtrar);

  // Control del select de exportación
  const selectExport = document.getElementById('selectExport');
  
  selectExport.addEventListener('change', (e) => {
    const formato = e.target.value;
    if (!formato) return;
    
    if (formato === 'excel') {
      exportarExcel();
    } else if (formato === 'pdf') {
      exportarPDF();
    } else if (formato === 'csv') {
      exportarCSV();
    }
    
    // Resetear el select
    e.target.value = '';
  });

  // Función para obtener datos de la tabla
  function obtenerDatosTabla() {
    const rows = [['Tipo','Nombre','ID','Categoria/Tipo','Laboratorio','Ubicacion','Estado/Cantidad','Info Adicional']];
    [...tbody.rows].forEach(r=>{
      if(r.classList.contains('d-none')) return;
      const c=(sel)=>r.querySelector(sel)?.innerText.trim().replace(/\n/g, ' ')||'';
      rows.push([
        c('td:nth-child(1)'),
        c('td:nth-child(2)').split('\n')[0],
        r.querySelector('td:nth-child(2) small')?.innerText.replace('ID: ','') || '',
        c('td:nth-child(3)'),
        c('td:nth-child(4)'),
        c('td:nth-child(5)'),
        c('td:nth-child(6)'),
        c('td:nth-child(7)')
      ]);
    });
    return rows;
  }

  // Exportar Excel
  function exportarExcel() {
    const rows = obtenerDatosTabla();
    
    // Crear HTML para Excel
    let html = '<table><thead><tr>';
    rows[0].forEach(h => html += `<th style="background:#2D6A4F;color:white;font-weight:bold;padding:8px;border:1px solid #ddd;">${h}</th>`);
    html += '</tr></thead><tbody>';
    
    for(let i=1; i<rows.length; i++){
      html += '<tr>';
      rows[i].forEach(c => html += `<td style="padding:6px;border:1px solid #ddd;">${c}</td>`);
      html += '</tr>';
    }
    html += '</tbody></table>';
    
    const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `inventario_${new Date().toISOString().split('T')[0]}.xls`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Exportar PDF
  function exportarPDF() {
    window.print();
  }

  // Exportar CSV
  function exportarCSV() {
    const rows = obtenerDatosTabla();
    const csv = rows.map(a=>a.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href=url; 
    a.download=`busqueda_global_${new Date().toISOString().split('T')[0]}.csv`; 
    a.click(); 
    URL.revokeObjectURL(url);
  }
</script>
{% endblock %}
