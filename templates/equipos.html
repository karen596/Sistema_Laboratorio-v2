{% extends 'base.html' %}
{% set title = 'Equipos' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0"><i class="bi bi-cpu me-2"></i>Listado de Equipos</h4>
  <div class="d-flex gap-2">
    <div class="input-group" style="max-width:380px;">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input id="filtroEquipos" type="text" class="form-control" placeholder="Buscar por nombre o tipo...">
    </div>
    <select id="filtroEstado" class="form-select" style="max-width:220px;">
      <option value="">Todos los estados</option>
      <option value="disponible">Disponible</option>
      <option value="en_uso">En uso</option>
      <option value="mantenimiento">Mantenimiento</option>
      <option value="fuera_servicio">Fuera de servicio</option>
    </select>
  </div>
</div>

<div class="table-responsive shadow-sm bg-white rounded">
  <table class="table table-hover align-middle mb-0" id="tablaEquipos">
    <thead class="table-light">
      <tr>
        <th>Nombre</th>
        <th>Tipo</th>
        <th><i class="bi bi-building me-1"></i>Laboratorio</th>
        <th>Estado</th>
        <th>Ubicación</th>
        <th>Calibración</th>
        <th>Mantenimiento</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for e in equipos %}
      <tr data-id="{{ e.id }}" data-nombre="{{ e.nombre|lower }}" data-tipo="{{ e.tipo|lower }}" data-estado="{{ e.estado }}">
        <td class="fw-semibold">{{ e.nombre }}</td>
        <td>{{ e.tipo }}</td>
        <td>
          <span class="badge bg-primary">
            {{ e.laboratorio_nombre or e.laboratorio_codigo or 'Sin asignar' }}
          </span>
        </td>
        <td>
          {% set badge = 'success' if e.estado=='disponible' else ('info' if e.estado=='en_uso' else ('warning' if e.estado=='mantenimiento' else 'danger')) %}
          <span class="badge bg-{{ badge }} text-uppercase">{{ e.estado }}</span>
        </td>
        <td>{{ e.ubicacion or '-' }}</td>
        <td>{{ e.calibracion or 'N/A' }}</td>
        <td>{{ e.mantenimiento or 'N/A' }}</td>
        <td class="text-end">
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-sena" data-bs-toggle="modal" data-bs-target="#modalEditarEquipo" 
                    data-equipo='{{ e|tojson }}'>Editar</button>
            <button class="btn btn-sm btn-sena" data-bs-toggle="modal" data-bs-target="#modalReservarEquipo" 
                    data-equipo='{{ e|tojson }}'>Reservar</button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal: Nuevo equipo -->
<div class="modal fade" id="modalNuevoEquipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Nuevo equipo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label">Nombre</label><input id="eqNombre" class="form-control" placeholder="Ej: Microscopio óptico"></div>
        <div class="mb-2"><label class="form-label">Tipo</label><input id="eqTipo" class="form-control" placeholder="Ej: EPP, Instrumento, Herramienta"></div>
        <div class="mb-2"><label class="form-label">Ubicación</label><input id="eqUbicacion" class="form-control" placeholder="Ej: A2, Laboratorio 1"></div>
        <div class="mb-2">
          <label class="form-label">Especificaciones</label>
          <textarea id="eqSpecs" class="form-control" rows="3" placeholder="Descripción libre o JSON. Ej: Marca Samsung, color negro"></textarea>
          <small class="text-muted">Puede ser texto libre o formato JSON</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-sena" id="btnCrearEquipo">Crear</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Editar equipo -->
<div class="modal fade" id="modalEditarEquipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Editar equipo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label">Estado</label>
          <select id="editEstado" class="form-select">
            <option value="disponible">Disponible</option>
            <option value="en_uso">En uso</option>
            <option value="mantenimiento">Mantenimiento</option>
            <option value="fuera_servicio">Fuera de servicio</option>
          </select>
        </div>
        <div class="mb-2"><label class="form-label">Ubicación</label><input id="editUbicacion" class="form-control"></div>
        <div class="mb-2">
          <label class="form-label">Especificaciones Técnicas</label>
          <textarea id="editSpecs" class="form-control" rows="4" placeholder="Marca, modelo, características principales..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-sena" id="btnGuardarEquipo">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Visión por cámara -->
<div class="modal fade" id="modalVision" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="bi bi-camera-video me-2"></i>Buscar equipo por imagen</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-7">
            <div class="ratio ratio-16x9 bg-dark rounded overflow-hidden">
              <video id="camPreview" autoplay playsinline muted class="w-100 h-100"></video>
            </div>
          </div>
          <div class="col-12 col-md-5">
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="modoSimple" checked>
              <label class="form-check-label small" for="modoSimple">Modo simple: solo reconocer</label>
            </div>
            <div class="mb-2">
              <label class="form-label small">Cámara</label>
              <select id="camDevice" class="form-select form-select-sm"></select>
            </div>
            <div id="advancedSection">
            <div class="mb-2">
              <label class="form-label small">Destino (equipo u objeto para guardar)</label>
              <select id="eqDestino" class="form-select form-select-sm"></select>
              <div class="form-text">Seleccione un Equipo para guardar plantilla o un Objeto para guardar vista.</div>
            </div>
            <div class="mb-2">
              <label class="form-label small">Subcarpeta (opcional)</label>
              <input id="tplCarpeta" class="form-control form-control-sm" placeholder="Ej: frontal, lateral">
            </div>
            <div class="mb-2">
              <div class="small text-muted mb-1">Plantillas existentes</div>
              <div id="tplGallery" class="d-flex flex-wrap gap-1"></div>
            </div>
            </div>
            <div class="alert alert-light border small" id="visionMsg">Apunte la cámara al equipo y presione Capturar.</div>
            <div id="visionResultado" class="small"></div>
          </div>
        </div>
        <canvas id="camCanvas" class="d-none"></canvas>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-sena" id="btnGuardarPlantilla" title="Guardar imagen actual como plantilla de reconocimiento" disabled><i class="bi bi-save"></i> Guardar plantilla</button>
          <button class="btn btn-sena" id="btnCapturarVision"><i class="bi bi-camera"></i> Capturar</button>
        </div>
      </div>
    </div>
  </div>
 </div>

<!-- Modal: Reservar equipo -->
<div class="modal fade" id="modalReservarEquipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Reservar equipo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label">Equipo</label><input id="resEquipoNombre" class="form-control" disabled></div>
        <div class="mb-2"><label class="form-label">Inicio</label><input id="resInicio" type="datetime-local" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Fin</label><input id="resFin" type="datetime-local" class="form-control"></div>
        <div class="mb-2"><label class="form-label">Observaciones</label><textarea id="resObs" class="form-control" rows="2"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-sena" id="btnCrearReserva">Reservar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Version: 2025-10-11-22:14 - Correccion de creacion de equipos
  const inputFiltro = document.getElementById('filtroEquipos');
  const selectEstado = document.getElementById('filtroEstado');
  const tbody = document.querySelector('#tablaEquipos tbody');

  function filtrar() {
    const t = (inputFiltro.value||'').toLowerCase();
    const est = selectEstado.value;
    [...tbody.rows].forEach(r=>{
      const okTexto = r.dataset.nombre.includes(t) || r.dataset.tipo.includes(t);
      const okEstado = !est || r.dataset.estado===est;
      r.classList.toggle('d-none', !(okTexto && okEstado));
    });
  }

  async function showObjetoDetalle(o){
    // Intenta obtener thumb (first_img_id) consultando /api/objetos?q=nombre
    let thumbId = null;
    try{
      const token = localStorage.getItem('jwt');
      const res = await fetch('/api/objetos?q='+encodeURIComponent(o.nombre), { headers: Object.assign({}, token? {'Authorization':'Bearer '+token}:{}) });
      const data = await res.json();
      const found = (data.objetos||[]).find(x=>x.id===o.id) || (data.objetos||[])[0];
      if(found && found.first_img_id) thumbId = found.first_img_id;
    }catch{}
    const imgHtml = thumbId ? `<img src="/api/objetos/imagen_thumb/${thumbId}" class="rounded border me-2" style="width:72px;height:72px;object-fit:cover;">` : '';
    visionResultado.innerHTML = `
      <div class="d-flex align-items-start mt-2">
        ${imgHtml}
        <div>
          <div class="fw-semibold">${o.nombre}${o.categoria? ' · '+o.categoria:''}</div>
          <div class="text-muted small">${o.descripcion? o.descripcion: ''}</div>
        </div>
      </div>`;
  }

  async function loadGalleryForSelection(sel){
    tplGallery.innerHTML = '<span class="text-muted small">Cargando...</span>';
    if(!sel){ tplGallery.innerHTML=''; return; }
    const [kind, id] = sel.split(':');
    try{
      if(kind==='eq'){
        const res = await fetch(`/api/vision/equipos/${id}/plantillas`);
        const data = await res.json();
        const arr = data.plantillas||[];
        if(arr.length===0){ tplGallery.innerHTML = '<span class="text-muted small">(sin plantillas)</span>'; return; }
        tplGallery.innerHTML = '';
        arr.slice(0,8).forEach(p=>{
          const img = document.createElement('img');
          img.src = `/api/vision/equipos/plantilla_image?equipo_id=${encodeURIComponent(id)}&f=${encodeURIComponent(p.file)}`;
          img.className = 'rounded border';
          img.style.width = '60px'; img.style.height='40px'; img.style.objectFit='cover';
          tplGallery.appendChild(img);
        });
        if(arr.length>8){
          const more = document.createElement('span'); more.className='small text-muted align-self-center';
          more.textContent = `+${arr.length-8} más`;
          tplGallery.appendChild(more);
        }
      } else if(kind==='obj'){
        // Requiere JWT para listar imágenes del objeto
        const token = localStorage.getItem('jwt');
        if(!token){ tplGallery.innerHTML = '<span class="text-warning small">Inicie sesión para ver vistas del objeto</span>'; return; }
        const res = await fetch(`/api/objetos/${id}/imagenes`, { headers: {'Authorization':'Bearer '+token} });
        const data = await res.json();
        const arr = (data.imagenes||[]);
        if(arr.length===0){ tplGallery.innerHTML = '<span class="text-muted small">(sin vistas)</span>'; return; }
        tplGallery.innerHTML = '';
        arr.slice(0,8).forEach(imgRow=>{
          const img = document.createElement('img');
          img.src = `/api/objetos/imagen_thumb/${imgRow.id}`;
          img.className = 'rounded border';
          img.style.width = '60px'; img.style.height='40px'; img.style.objectFit='cover';
          tplGallery.appendChild(img);
        });
        if(arr.length>8){
          const more = document.createElement('span'); more.className='small text-muted align-self-center';
          more.textContent = `+${arr.length-8} más`;
          tplGallery.appendChild(more);
        }
      }
    }catch(e){ tplGallery.innerHTML = '<span class="text-danger small">Error cargando galería</span>'; }
  }

  inputFiltro.addEventListener('input', filtrar);
  selectEstado.addEventListener('change', filtrar);

  let equipoReservaId = null;
  document.getElementById('modalReservarEquipo').addEventListener('show.bs.modal', (ev)=>{
    const btn = ev.relatedTarget;
    try {
      const equipo = JSON.parse(btn.getAttribute('data-equipo'));
      equipoReservaId = equipo.id;
      document.getElementById('resEquipoNombre').value = `${equipo.nombre} (${equipo.id})`;
    } catch {}
    const now = new Date(); const in1h = new Date(now.getTime()+60*60*1000);
    const fmt = (d)=> d.toISOString().slice(0,16);
    document.getElementById('resInicio').value = fmt(now);
    document.getElementById('resFin').value = fmt(in1h);
    document.getElementById('resObs').value = '';
  });

  document.getElementById('btnCrearReserva').addEventListener('click', async ()=>{
    const token = localStorage.getItem('jwt');
    if(!token){ alert('Inicie sesión API (llave en barra superior)'); return; }
    const fecha_inicio = document.getElementById('resInicio').value;
    const fecha_fin = document.getElementById('resFin').value;
    const observaciones = document.getElementById('resObs').value;
    if(!fecha_inicio || !fecha_fin){ alert('Complete fechas de inicio y fin'); return; }
    try{
      const res = await fetch('/api/reservas',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
        body:JSON.stringify({equipo_id:equipoReservaId,fecha_inicio,fecha_fin,observaciones})
      });
      const data = await res.json();
      if(res.ok){ location.href = '/reservas'; }
      else{ alert(data?.message || 'Error creando reserva'); }
    }catch(e){ alert('Error creando reserva: '+e.message); }
  });
  // Inicializar filtro al cargar
  filtrar();

  // Cargar laboratorios y limpiar formulario al abrir modal
  document.getElementById('modalNuevoEquipo').addEventListener('show.bs.modal', async ()=>{
    // Limpiar formulario
    document.getElementById('eqNombre').value = '';
    document.getElementById('eqTipo').value = '';
    document.getElementById('eqLaboratorio').value = '';
    document.getElementById('eqEstado').value = 'disponible';
    document.getElementById('eqUbicacion').value = '';
    document.getElementById('eqMarca').value = '';
    document.getElementById('eqModelo').value = '';
    document.getElementById('eqSerie').value = '';
    document.getElementById('eqAnio').value = '';
    document.getElementById('eqDescripcion').value = '';
    document.getElementById('eqSpecs').value = '{}';
    
    // Cargar laboratorios
    try{
      const res = await fetch('/api/laboratorios');
      const data = await res.json();
      const laboratorios = data.laboratorios || [];
      const select = document.getElementById('eqLaboratorio');
      select.innerHTML = '<option value="">Seleccionar laboratorio...</option>' + 
        laboratorios.map(lab => `<option value="${lab.id}">${lab.codigo} - ${lab.nombre}</option>`).join('');
    }catch(e){
      console.error('Error cargando laboratorios:', e);
    }
  });

  // Crear equipo via web (sin JWT)
  document.getElementById('btnCrearEquipo').addEventListener('click', async ()=>{
    try{
      const nombre = document.getElementById('eqNombre').value.trim();
      const tipo = document.getElementById('eqTipo').value.trim();
      const ubicacion = document.getElementById('eqUbicacion').value.trim();
      const specsText = document.getElementById('eqSpecs').value.trim();
      
      if(!nombre){ alert('El nombre es requerido'); return; }
      if(!tipo){ alert('El tipo es requerido'); return; }
      
      // Intentar parsear como JSON, si falla usar como texto
      let specs = {};
      if(specsText){
        try{
          specs = JSON.parse(specsText);
        }catch(e){
          // Si no es JSON válido, usar como descripción de texto
          specs = {descripcion: specsText};
        }
      }
      
      // Usar sesión web en lugar de JWT
      const res = await fetch('/api/equipos',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({nombre, tipo, ubicacion, especificaciones:specs})
      });
      
      if(res.ok){ 
        alert('Equipo creado exitosamente');
        location.reload(); 
      } else { 
        const data = await res.json();
        alert('Error creando equipo: ' + (data.message || 'Error desconocido')); 
      }
    }catch(e){ 
      alert('Error: '+e.message); 
    }
  });

  // Editar equipo (cargar datos desde botón)
  let equipoActualId = null;
  document.getElementById('modalEditarEquipo').addEventListener('show.bs.modal', (ev)=>{
    const btn = ev.relatedTarget;
    const equipo = JSON.parse(btn.getAttribute('data-equipo'));
    equipoActualId = equipo.id;
    document.getElementById('editEstado').value = equipo.estado;
    document.getElementById('editUbicacion').value = equipo.ubicacion||'';
    document.getElementById('editSpecs').value = equipo.especificaciones || '';
  });

  document.getElementById('btnGuardarEquipo').addEventListener('click', async ()=>{
    try{
      const estado = document.getElementById('editEstado').value;
      const ubicacion = document.getElementById('editUbicacion').value;
      const especificaciones = document.getElementById('editSpecs').value.trim();
      
      const res = await fetch('/api/equipos/'+equipoActualId,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({estado, ubicacion, especificaciones})
      });
      
      if(res.ok){ 
        alert('Equipo actualizado exitosamente');
        location.reload(); 
      } else { 
        const data = await res.json();
        alert('Error guardando: ' + (data.message || 'Error desconocido')); 
      }
    }catch(e){
      alert('Error: ' + e.message);
    }
  });

  // --- Visión por cámara ---
  const modalVision = document.getElementById('modalVision');
  const video = document.getElementById('camPreview');
  const canvas = document.getElementById('camCanvas');
  const btnCapturar = document.getElementById('btnCapturarVision');
  const visionMsg = document.getElementById('visionMsg');
  const visionResultado = document.getElementById('visionResultado');
  const camDevice = document.getElementById('camDevice');
  const eqDestino = document.getElementById('eqDestino');
  const tplCarpeta = document.getElementById('tplCarpeta');
  const tplGallery = document.getElementById('tplGallery');
  const modoSimple = document.getElementById('modoSimple');
  const advancedSection = document.getElementById('advancedSection');
  let stream = null;

  function setVisionMsg(kind, text){
    const map = { info:'alert-light border', warn:'alert-warning', err:'alert-danger', ok:'alert-success' };
    visionMsg.className = 'alert small ' + (map[kind]||'alert-light border');
    visionMsg.textContent = text;
  }

  async function startCamera(deviceId){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      setVisionMsg('err','Este navegador no soporta acceso a cámara');
      return;
    }
    try{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      const constraints = deviceId ? { video: { deviceId: { exact: deviceId } }, audio: false }
                                   : { video: { facingMode: 'environment', width: { ideal: 1280 } }, audio: false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      setVisionMsg('info','Apunte la cámara al equipo y presione Capturar.');
    }catch(e){
      console.warn('getUserMedia error', e);
      let msg = 'No se pudo acceder a la cámara';
      if(e.name==='NotAllowedError') msg = 'Permiso de cámara denegado. Habilite el acceso en el navegador.';
      else if(e.name==='NotFoundError' || e.name==='OverconstrainedError') msg = 'No se encontró ningún dispositivo de cámara disponible.';
      else if(e.name==='NotReadableError') msg = 'La cámara está siendo utilizada por otra aplicación.';
      setVisionMsg('err', msg + (e.message? ' · '+e.message:''));
    }
  }

  async function refreshDevices(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      camDevice.innerHTML = cams.map((d,i)=>`<option value="${d.deviceId}">${d.label||('Cámara '+(i+1))}</option>`).join('');
      if(cams.length>0 && !stream){ await startCamera(camDevice.value); }
    }catch(e){ /* ignore */ }
  }

  modalVision?.addEventListener('shown.bs.modal', async ()=>{
    setVisionMsg('info','Inicializando cámara...');
    // Intentar prefetchear permisos (solo en contextos seguros; localhost es seguro)
    try{ await refreshDevices(); }catch{}
    // Cargar lista de equipos (DOM) y objetos (API) solo si no está en modo simple
    try{
      if(!modoSimple.checked){
        const rows = [...document.querySelectorAll('#tablaEquipos tbody tr')];
        const optEquipos = rows.map(r=>`<option value="eq:${r.getAttribute('data-id')}">${r.children[0].textContent}</option>`).join('');
        let optObjetos = '';
        try{
          const token = localStorage.getItem('jwt');
          if(token){
            const res = await fetch('/api/objetos', { headers:{'Authorization':'Bearer '+token} });
            const data = await res.json();
            optObjetos = (data.objetos||[]).map(o=>`<option value="obj:${o.id}">${o.nombre}</option>`).join('');
          }
        }catch{}
        eqDestino.innerHTML = `${optEquipos? `<optgroup label="Equipos">${optEquipos}</optgroup>`:''}${optObjetos? `<optgroup label="Objetos">${optObjetos}</optgroup>`:''}`;
      }
    }catch{}
    if(!modoSimple.checked && eqDestino.value) loadGalleryForSelection(eqDestino.value);
    await startCamera(camDevice.value);
  });
  modalVision?.addEventListener('hidden.bs.modal', ()=>{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject=null; visionResultado.innerHTML=''; setVisionMsg('info','Apunte la cámara al equipo y presione Capturar.');
  });

  camDevice?.addEventListener('change', ()=>startCamera(camDevice.value));
  eqDestino?.addEventListener('change', ()=> loadGalleryForSelection(eqDestino.value));

  // Toggle modo simple
  function applyModoSimple(){
    const simple = modoSimple.checked;
    advancedSection.style.display = simple ? 'none' : '';
    document.getElementById('btnGuardarPlantilla').disabled = simple;
    setVisionMsg('info', simple ? 'Apunte la cámara y presione Capturar.' : 'Apunte la cámara al equipo/objeto y use las opciones para guardar si desea.');
  }
  modoSimple.addEventListener('change', applyModoSimple);
  applyModoSimple();

  // Guardar frame actual como plantilla (equipo) o vista (objeto)
  document.getElementById('btnGuardarPlantilla')?.addEventListener('click', async ()=>{
    if(!video.videoWidth){ setVisionMsg('warn','La cámara aún no está lista'); return; }
    const sel = eqDestino.value;
    if(!sel){ setVisionMsg('warn','Seleccione un destino'); return; }
    const [kind, id] = sel.split(':');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    setVisionMsg('info', kind==='eq' ? 'Guardando plantilla...' : 'Guardando vista del objeto...');
    try{
      const token = localStorage.getItem('jwt');
      let res, data;
      const sub = (tplCarpeta.value.trim()||'frontal');
      if(kind==='eq'){
        res = await fetch(`/api/vision/equipos/${id}/plantilla`, { method:'POST', headers: Object.assign({'Content-Type':'application/json'}, token? {'Authorization':'Bearer '+token}:{} ), body: JSON.stringify({ image_base64: dataUrl, carpeta: sub }) });
        data = await res.json();
        if(res.ok){ setVisionMsg('ok','Plantilla guardada correctamente'); }
        else { setVisionMsg('err', data?.message||'No se pudo guardar la plantilla'); }
      } else if(kind==='obj'){
        if(!token){ setVisionMsg('warn','Inicie sesión API para guardar vistas de objetos'); return; }
        res = await fetch(`/api/objetos/${id}/imagenes`, { method:'POST', headers: {'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ image_base64: dataUrl, notas: '', carpeta: '', fuente:'camera', tipo_registro:'objeto', vista: sub }) });
        data = await res.json();
        if(res.ok){ setVisionMsg('ok','Vista del objeto guardada'); }
        else { setVisionMsg('err', data?.message||'No se pudo guardar la vista'); }
      }
      loadGalleryForSelection(eqDestino.value);
    }catch(e){ setVisionMsg('err','Error guardando: '+e.message); }
  });

  btnCapturar?.addEventListener('click', async ()=>{
    if(!video.videoWidth){ return; }
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    visionMsg.className='alert alert-warning small'; visionMsg.textContent='Buscando coincidencias...';
    try{
      const res = await fetch('/api/vision/match',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image_base64:dataUrl})});
      const data = await res.json();
      // Confirmed EQUIPO
      if(data?.tipo==='equipo' && data?.equipo){
        visionMsg.className='alert alert-success small';
        const scoreTxt = data?.match?.score? ` · score ${data.match.score}`:'';
        visionMsg.textContent=`Coincidencia: ${data.equipo.nombre} (${data.equipo.id}) · Estado: ${data.equipo.estado} · Ubicación: ${data.equipo.ubicacion}${scoreTxt}`;
        const row = [...tbody.rows].find(r=>r.dataset.id===data.equipo.id);
        if(row){ row.classList.add('table-success'); row.scrollIntoView({behavior:'smooth', block:'center'}); }
        return;
      }
      // Confirmed OBJETO
      if(data?.tipo==='objeto' && data?.objeto){
        const o = data.objeto;
        visionMsg.className='alert alert-success small';
        const scoreTxt = data?.match?.score? ` · score ${data.match.score}`:'';
        visionMsg.innerHTML = `Coincidencia de objeto: <strong>${o.nombre}</strong>${o.categoria? ' · '+o.categoria:''}${scoreTxt} <button class="btn btn-link btn-sm ms-2 p-0" id="btnVerDetalles">Ver detalles</button>`;
        document.getElementById('btnVerDetalles')?.addEventListener('click', ()=> showObjetoDetalle(o));
        return;
      }
      // SUGERENCIAS
      if(data?.tipo==='sugerencia'){
        const scoreTxt = data?.match?.score? ` · score ${data.match.score}`:'';
        if(data.categoria==='objeto'){
          if(data.objeto){
            visionMsg.className='alert alert-info small';
            visionMsg.innerHTML = `Más parecido (baja confianza): <strong>${data.objeto.nombre}</strong>${data.objeto.categoria? ' · '+data.objeto.categoria:''}${scoreTxt} <button class="btn btn-link btn-sm ms-2 p-0" id="btnVerDetalles">Ver detalles</button>`;
            document.getElementById('btnVerDetalles')?.addEventListener('click', ()=> showObjetoDetalle(data.objeto));
          } else if(data.key){
            visionMsg.className='alert alert-info small';
            visionMsg.innerHTML = `Más parecido (carpeta): <strong>${data.key}</strong>${scoreTxt}`;
          }
        } else if(data.categoria==='equipo'){
          if(data.equipo){
            visionMsg.className='alert alert-info small';
            visionMsg.innerHTML = `Más parecido (equipo): <strong>${data.equipo.nombre}</strong> (${data.equipo.id})${scoreTxt}`;
          } else if(data.key){
            visionMsg.className='alert alert-info small';
            visionMsg.textContent = `Sugerencia de equipo (id): ${data.key}${scoreTxt}`;
          }
        }
        return;
      }
      // Sin coincidencias
      visionMsg.className='alert alert-info small';
      visionMsg.textContent = data?.message || 'Sin coincidencias';
    }catch(e){
      visionMsg.className='alert alert-danger small'; visionMsg.textContent='Error consultando visión: '+e.message;
    }
  });
</script>
{% endblock %}
