{% extends 'base.html' %}
{% set title = 'Dashboard' %}
{% block content %}
<style>
  .stat-card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }
  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
  }
  .stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
  }
  .gradient-sena {
    background: linear-gradient(135deg, #2d6a4f 0%, #1e5128 100%);
  }
  .gradient-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }
  .gradient-info {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  }
  .gradient-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }
  .gradient-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  }
  .gradient-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  }
  .card-header-custom {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
  }
  .activity-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-left: 3px solid #2d6a4f;
    transition: all 0.3s ease;
  }
  .activity-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
  }
  .quick-action-card {
    border: 2px dashed #dee2e6;
    border-radius: 15px;
    transition: all 0.3s ease;
  }
  .quick-action-card:hover {
    border-color: #2d6a4f;
    background: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 106, 79, 0.1);
  }
</style>

<!-- Bienvenida -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #2d6a4f 0%, #1e5128 100%);">
      <div class="card-body text-white p-4">
        <h3 class="mb-2 fw-bold"><i class="bi bi-speedometer2 me-2"></i>Dashboard - Centro Minero SENA</h3>
        <p class="mb-0 opacity-75">Bienvenido, {{ user.get('nombre', 'Usuario') }} | Nivel de acceso: {{ user.get('user_level', 1) }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Tarjetas de Estadísticas -->
<div class="row g-4 mb-4">
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card stat-card">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-label mb-2">Equipos Activos</div>
            <div class="stat-value text-success">{{ stats.get('equipos_activos', 0) }}</div>
          </div>
          <div class="stat-icon gradient-sena text-white">
            <i class="bi bi-cpu"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card stat-card">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-label mb-2">Inventario OK</div>
            <div class="stat-value text-success">{{ stats.get('inventario_bien', 0) }}</div>
          </div>
          <div class="stat-icon gradient-success text-white">
            <i class="bi bi-check-circle-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card stat-card">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-label mb-2">Reservas Próximas</div>
            <div class="stat-value text-info">{{ stats.get('reservas_proximas', 0) }}</div>
          </div>
          <div class="stat-icon gradient-info text-white">
            <i class="bi bi-calendar-event-fill"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-sm-6 col-lg-3">
    <div class="card stat-card">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="stat-label mb-2">Laboratorios</div>
            <div class="stat-value text-primary">{{ stats.get('total_laboratorios', 0) }}</div>
          </div>
          <div class="stat-icon gradient-primary text-white">
            <i class="bi bi-building"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Acciones Rápidas (Solo Administradores) -->
{% if user and user.get('user_level',0) >= 4 %}
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header card-header-custom">
        <i class="bi bi-lightning-charge-fill me-2"></i>Acciones Rápidas - Administrador
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card quick-action-card h-100">
              <div class="card-body text-center p-4">
                <div class="stat-icon gradient-sena text-white mx-auto mb-3">
                  <i class="bi bi-plus-circle-fill"></i>
                </div>
                <h6 class="fw-bold mb-2">Registrar Equipo/Item</h6>
                <p class="small text-muted mb-3">Registro completo con fotos e IA</p>
                <a class="btn btn-sena btn-sm" href="{{ url_for('registro_completo') }}">
                  <i class="bi bi-plus-circle me-1"></i>Ir
                </a>
              </div>
            </div>
          </div>
          
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card quick-action-card h-100">
              <div class="card-body text-center p-4">
                <div class="stat-icon gradient-primary text-white mx-auto mb-3">
                  <i class="bi bi-people-fill"></i>
                </div>
                <h6 class="fw-bold mb-2">Gestionar Usuarios</h6>
                <p class="small text-muted mb-3">Crear y editar usuarios</p>
                <a class="btn btn-primary btn-sm" href="{{ url_for('usuarios') }}">
                  <i class="bi bi-person-plus me-1"></i>Ir
                </a>
              </div>
            </div>
          </div>
          
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card quick-action-card h-100">
              <div class="card-body text-center p-4">
                <div class="stat-icon gradient-warning text-white mx-auto mb-3">
                  <i class="bi bi-database"></i>
                </div>
                <h6 class="fw-bold mb-2">Backup BD</h6>
                <p class="small text-muted mb-3">Respaldar base de datos</p>
                <a class="btn btn-warning btn-sm" href="{{ url_for('backup') }}">
                  <i class="bi bi-download me-1"></i>Ir
                </a>
              </div>
            </div>
          </div>
          
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card quick-action-card h-100">
              <div class="card-body text-center p-4">
                <div class="stat-icon gradient-danger text-white mx-auto mb-3">
                  <i class="bi bi-gear-fill"></i>
                </div>
                <h6 class="fw-bold mb-2">Configuración</h6>
                <p class="small text-muted mb-3">Ajustes del sistema</p>
                <a class="btn btn-danger btn-sm" href="{{ url_for('configuracion') }}">
                  <i class="bi bi-sliders me-1"></i>Ir
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Gráficos y Actividad -->
<div class="row g-4">
  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm">
      <div class="card-header card-header-custom">
        <i class="bi bi-graph-up-arrow me-2"></i>Uso de Equipos - Última Semana
      </div>
      <div class="card-body p-4">
        <canvas id="chartUso" style="max-height: 300px;"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header card-header-custom">
        <i class="bi bi-activity me-2"></i>Actividad Reciente
      </div>
      <div class="card-body p-3" style="max-height: 350px; overflow-y: auto;">
        <div id="actividadReciente">
          <div class="activity-item">
            <div class="d-flex align-items-center">
              <i class="bi bi-clock-history text-muted me-2"></i>
              <small class="text-muted">Cargando actividad...</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Accesos Directos Adicionales -->
<div class="row g-4 mt-2">
  <div class="col-12 col-md-6 col-lg-3">
    <a href="{{ url_for('laboratorios') }}" class="text-decoration-none">
      <div class="card border-0 shadow-sm quick-action-card h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon gradient-info text-white mx-auto mb-3">
            <i class="bi bi-building"></i>
          </div>
          <h6 class="fw-bold text-dark">Laboratorios</h6>
          <p class="small text-muted mb-0">Ver espacios disponibles</p>
        </div>
      </div>
    </a>
  </div>
  
  <div class="col-12 col-md-6 col-lg-3">
    <a href="{{ url_for('equipos') }}" class="text-decoration-none">
      <div class="card border-0 shadow-sm quick-action-card h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon gradient-sena text-white mx-auto mb-3">
            <i class="bi bi-laptop"></i>
          </div>
          <h6 class="fw-bold text-dark">Equipos</h6>
          <p class="small text-muted mb-0">Consultar catálogo</p>
        </div>
      </div>
    </a>
  </div>
  
  <div class="col-12 col-md-6 col-lg-3">
    <a href="{{ url_for('inventario') }}" class="text-decoration-none">
      <div class="card border-0 shadow-sm quick-action-card h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon gradient-success text-white mx-auto mb-3">
            <i class="bi bi-box-seam"></i>
          </div>
          <h6 class="fw-bold text-dark">Inventario</h6>
          <p class="small text-muted mb-0">Ver stock disponible</p>
        </div>
      </div>
    </a>
  </div>
  
  <div class="col-12 col-md-6 col-lg-3">
    <a href="{{ url_for('reservas') }}" class="text-decoration-none">
      <div class="card border-0 shadow-sm quick-action-card h-100">
        <div class="card-body text-center p-4">
          <div class="stat-icon gradient-primary text-white mx-auto mb-3">
            <i class="bi bi-calendar-check"></i>
          </div>
          <h6 class="fw-bold text-dark">Reservas</h6>
          <p class="small text-muted mb-0">Gestionar reservas</p>
        </div>
      </div>
    </a>
  </div>
</div>

<script>
  // Gráfico de uso de equipos
  const ctx = document.getElementById('chartUso');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'],
      datasets: [{
        label: 'Usos de Equipos',
        data: [12, 19, 15, 17, 14, 8, 6],
        backgroundColor: 'rgba(45, 106, 79, 0.85)',
        borderColor: 'rgba(30, 81, 40, 1)',
        borderWidth: 2,
        borderRadius: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          borderRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
  
  // Cargar actividad reciente
  fetch('/api/actividad_reciente')
    .then(r => r.json())
    .then(data => {
      const container = document.getElementById('actividadReciente');
      if(data.actividades && data.actividades.length > 0) {
        container.innerHTML = data.actividades.map(act => `
          <div class="activity-item">
            <div class="d-flex align-items-start">
              <i class="bi bi-${act.icon || 'circle-fill'} text-success me-2 mt-1"></i>
              <div class="flex-grow-1">
                <div class="small fw-semibold">${act.titulo}</div>
                <div class="small text-muted">${act.descripcion}</div>
                <div class="small text-muted"><i class="bi bi-clock me-1"></i>${act.fecha}</div>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        container.innerHTML = `
          <div class="activity-item text-center">
            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
            <p class="small text-muted mb-0 mt-2">No hay actividad reciente</p>
          </div>
        `;
      }
    })
    .catch(() => {
      document.getElementById('actividadReciente').innerHTML = `
        <div class="activity-item">
          <small class="text-muted"><i class="bi bi-exclamation-circle me-2"></i>Error cargando actividad</small>
        </div>
      `;
    });
</script>
{% endblock %}
